{"ast":null,"code":"import { computed, onMounted, onBeforeUnmount, reactive, ref, watch } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { RefreshRight } from '@element-plus/icons-vue';\nimport { sanitizeInput, validatePhoneNumber, validatePasswordStrength } from '../../utils/security';\nimport SkeletonCard from '../../components/common/SkeletonCard.vue';\nconst draftStorageKey = 'user.profile.draft';\nexport default {\n  __name: 'Profile',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    const store = useStore();\n    const profile = computed(() => store.getters['user/userProfile'] || {});\n    const roles = computed(() => store.getters['auth/currentUser']?.roles || []);\n    const editing = ref(false);\n    const infoLoading = ref(false);\n    const passwordLoading = ref(false);\n    const deviceLoading = ref(false);\n    const infoFormRef = ref();\n    const passwordFormRef = ref();\n    const infoForm = reactive({\n      username: '',\n      email: '',\n      phone: '',\n      bio: ''\n    });\n    const passwordForm = reactive({\n      oldPassword: '',\n      newPassword: '',\n      confirmPassword: ''\n    });\n    const devices = ref([]);\n    const userLoading = computed(() => store.getters['user/userLoading']);\n    const globalLoading = computed(() => store.getters.globalLoading);\n    const isBusy = computed(() => userLoading.value || globalLoading.value);\n    const infoRules = {\n      phone: [{\n        validator: (_, value, callback) => {\n          if (!value) {\n            callback();\n            return;\n          }\n          const sanitized = sanitizeInput(value);\n          if (sanitized !== value) {\n            infoForm.phone = sanitized;\n          }\n          const result = validatePhoneNumber(sanitized);\n          if (result !== true) {\n            callback(new Error(result));\n          } else {\n            callback();\n          }\n        },\n        trigger: ['blur', 'change']\n      }],\n      bio: [{\n        min: 0,\n        max: 200,\n        message: '简介内容需少于 200 字',\n        trigger: 'blur'\n      }]\n    };\n    const passwordRules = {\n      oldPassword: [{\n        required: true,\n        message: '请输入当前密码',\n        trigger: 'blur'\n      }],\n      newPassword: [{\n        required: true,\n        message: '请输入新密码',\n        trigger: 'blur'\n      }, {\n        validator: (_, value, callback) => {\n          const result = validatePasswordStrength(value);\n          if (!result.valid) {\n            callback(new Error(result.feedback[0] || '密码复杂度不足'));\n          } else {\n            callback();\n          }\n        },\n        trigger: 'change'\n      }],\n      confirmPassword: [{\n        required: true,\n        message: '请确认新密码',\n        trigger: 'blur'\n      }, {\n        validator: (_, value, callback) => {\n          if (value !== passwordForm.newPassword) {\n            callback(new Error('两次输入的密码不一致'));\n          } else {\n            callback();\n          }\n        },\n        trigger: ['blur', 'change']\n      }]\n    };\n    const initials = computed(() => {\n      const name = infoForm.username || profile.value.username || '';\n      return name.slice(0, 1).toUpperCase();\n    });\n    const userAvatar = computed(() => profile.value.avatar || store.getters['auth/currentUser']?.avatar);\n    const userDisplayName = computed(() => profile.value.username || '未命名用户');\n    const maskedPhone = computed(() => {\n      const phone = profile.value.phone;\n      if (!phone) return '未绑定';\n      return phone.replace(/^(\\d{3})\\d{4}(\\d{4})$/, '$1****$2');\n    });\n    const primaryRole = computed(() => roles.value?.[0] || '');\n    const formattedRegisterTime = computed(() => formatDate(profile.value.createdAt));\n    const latestDeviceTime = computed(() => {\n      if (!devices.value.length) return '暂无记录';\n      return formatRelative(devices.value[0]?.lastActiveAt);\n    });\n    function formatDate(value) {\n      if (!value) return '未知';\n      const date = new Date(value);\n      if (Number.isNaN(date.getTime())) return '未知';\n      return date.toLocaleString();\n    }\n    function formatRelative(date) {\n      if (!date) return '未知';\n      const now = Date.now();\n      const diff = now - new Date(date).getTime();\n      if (diff < 0) return '刚刚';\n      const minutes = Math.floor(diff / 60000);\n      if (minutes < 1) return '刚刚';\n      if (minutes < 60) return `${minutes} 分钟前`;\n      const hours = Math.floor(minutes / 60);\n      if (hours < 24) return `${hours} 小时前`;\n      const days = Math.floor(hours / 24);\n      if (days < 7) return `${days} 天前`;\n      return formatDate(date);\n    }\n    function fillInfoForm(data) {\n      infoForm.username = data.username || '';\n      infoForm.email = data.email || '';\n      infoForm.phone = data.phone || '';\n      infoForm.bio = data.bio || '';\n    }\n    function restoreDraft() {\n      try {\n        const draft = localStorage.getItem(draftStorageKey);\n        if (!draft) return;\n        const parsed = JSON.parse(draft);\n        infoForm.phone = parsed.phone || infoForm.phone;\n        infoForm.bio = parsed.bio || infoForm.bio;\n      } catch (error) {\n        console.warn('读取个人资料草稿失败:', error);\n      }\n    }\n    function clearDraft() {\n      localStorage.removeItem(draftStorageKey);\n    }\n    async function loadProfile(force = false) {\n      try {\n        const data = await store.dispatch('user/fetchProfile', {\n          force\n        });\n        fillInfoForm(data);\n        restoreDraft();\n      } catch (error) {\n        console.error('获取用户信息失败', error);\n      }\n    }\n    async function loadDevices() {\n      deviceLoading.value = true;\n      try {\n        const data = await store.dispatch('user/fetchDevices');\n        devices.value = data;\n      } catch (error) {\n        console.error('获取设备信息失败', error);\n        devices.value = [];\n      } finally {\n        deviceLoading.value = false;\n      }\n    }\n    function toggleEdit() {\n      editing.value = !editing.value;\n      if (!editing.value) {\n        resetInfo();\n        clearDraft();\n      } else {\n        restoreDraft();\n      }\n    }\n    function resetInfo() {\n      fillInfoForm(profile.value || {});\n      infoFormRef.value?.clearValidate();\n    }\n    function resetPasswordForm() {\n      passwordForm.oldPassword = '';\n      passwordForm.newPassword = '';\n      passwordForm.confirmPassword = '';\n      passwordFormRef.value?.clearValidate();\n    }\n    function submitInfo() {\n      if (!infoFormRef.value) return;\n      infoFormRef.value.validate(async valid => {\n        if (!valid) return;\n        infoLoading.value = true;\n        try {\n          await store.dispatch('user/updateProfile', {\n            phone: sanitizeInput(infoForm.phone),\n            bio: sanitizeInput(infoForm.bio)\n          });\n          await loadProfile(true);\n          ElMessage.success('个人信息已更新');\n          editing.value = false;\n          clearDraft();\n        } catch (error) {\n          ElMessage.error(error?.message || '更新个人信息失败');\n        } finally {\n          infoLoading.value = false;\n        }\n      });\n    }\n    function submitPassword() {\n      if (!passwordFormRef.value) return;\n      passwordFormRef.value.validate(async valid => {\n        if (!valid) return;\n        passwordLoading.value = true;\n        try {\n          await store.dispatch('user/changePassword', {\n            oldPassword: passwordForm.oldPassword,\n            newPassword: passwordForm.newPassword\n          });\n          ElMessage.success('密码修改成功，请使用新密码重新登录');\n          resetPasswordForm();\n        } catch (error) {\n          ElMessage.error(error?.message || '密码修改失败，请稍后再试');\n        } finally {\n          passwordLoading.value = false;\n        }\n      });\n    }\n    onMounted(async () => {\n      if (!profile.value || !Object.keys(profile.value).length) {\n        await loadProfile();\n      } else {\n        fillInfoForm(profile.value);\n        restoreDraft();\n      }\n      await loadDevices();\n    });\n    const draftFields = computed(() => ({\n      phone: infoForm.phone,\n      bio: infoForm.bio\n    }));\n    let draftTimer = null;\n    watch([draftFields, editing], ([fields, isEditing]) => {\n      if (!isEditing) return;\n      if (draftTimer) clearTimeout(draftTimer);\n      draftTimer = setTimeout(() => {\n        try {\n          localStorage.setItem(draftStorageKey, JSON.stringify(fields));\n        } catch (error) {\n          console.warn('保存个人资料草稿失败:', error);\n        }\n      }, 500);\n    }, {\n      deep: true\n    });\n    onBeforeUnmount(() => {\n      if (draftTimer) clearTimeout(draftTimer);\n    });\n    const __returned__ = {\n      store,\n      profile,\n      roles,\n      editing,\n      infoLoading,\n      passwordLoading,\n      deviceLoading,\n      draftStorageKey,\n      infoFormRef,\n      passwordFormRef,\n      infoForm,\n      passwordForm,\n      devices,\n      userLoading,\n      globalLoading,\n      isBusy,\n      infoRules,\n      passwordRules,\n      initials,\n      userAvatar,\n      userDisplayName,\n      maskedPhone,\n      primaryRole,\n      formattedRegisterTime,\n      latestDeviceTime,\n      formatDate,\n      formatRelative,\n      fillInfoForm,\n      restoreDraft,\n      clearDraft,\n      loadProfile,\n      loadDevices,\n      toggleEdit,\n      resetInfo,\n      resetPasswordForm,\n      submitInfo,\n      submitPassword,\n      draftFields,\n      get draftTimer() {\n        return draftTimer;\n      },\n      set draftTimer(v) {\n        draftTimer = v;\n      },\n      computed,\n      onMounted,\n      onBeforeUnmount,\n      reactive,\n      ref,\n      watch,\n      get useStore() {\n        return useStore;\n      },\n      get ElMessage() {\n        return ElMessage;\n      },\n      get RefreshRight() {\n        return RefreshRight;\n      },\n      get sanitizeInput() {\n        return sanitizeInput;\n      },\n      get validatePhoneNumber() {\n        return validatePhoneNumber;\n      },\n      get validatePasswordStrength() {\n        return validatePasswordStrength;\n      },\n      SkeletonCard\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["computed","onMounted","onBeforeUnmount","reactive","ref","watch","useStore","ElMessage","RefreshRight","sanitizeInput","validatePhoneNumber","validatePasswordStrength","SkeletonCard","draftStorageKey","store","profile","getters","roles","editing","infoLoading","passwordLoading","deviceLoading","infoFormRef","passwordFormRef","infoForm","username","email","phone","bio","passwordForm","oldPassword","newPassword","confirmPassword","devices","userLoading","globalLoading","isBusy","value","infoRules","validator","_","callback","sanitized","result","Error","trigger","min","max","message","passwordRules","required","valid","feedback","initials","name","slice","toUpperCase","userAvatar","avatar","userDisplayName","maskedPhone","replace","primaryRole","formattedRegisterTime","formatDate","createdAt","latestDeviceTime","length","formatRelative","lastActiveAt","date","Date","Number","isNaN","getTime","toLocaleString","now","diff","minutes","Math","floor","hours","days","fillInfoForm","data","restoreDraft","draft","localStorage","getItem","parsed","JSON","parse","error","console","warn","clearDraft","removeItem","loadProfile","force","dispatch","loadDevices","toggleEdit","resetInfo","clearValidate","resetPasswordForm","submitInfo","validate","success","submitPassword","Object","keys","draftFields","draftTimer","fields","isEditing","clearTimeout","setTimeout","setItem","stringify","deep"],"sources":["C:/Users/Administrator/Desktop/zonshe/ecommerce-frontend/src/pages/user/Profile.vue"],"sourcesContent":["<template>\n  <div class=\"profile-wrapper\">\n    <div v-if=\"isBusy\" class=\"profile-skeleton-stack\">\n      <SkeletonCard />\n      <SkeletonCard />\n    </div>\n\n    <el-row v-else :gutter=\"20\">\n      <el-col :xs=\"24\" :md=\"8\">\n        <el-card class=\"profile-card\" shadow=\"hover\">\n          <div class=\"profile-summary\">\n            <el-avatar :src=\"userAvatar\" size=\"large\">\n              {{ initials }}\n            </el-avatar>\n            <div class=\"summary-info\">\n              <h2>{{ userDisplayName }}</h2>\n              <p class=\"summary-email\">{{ profile.email || '未绑定邮箱' }}</p>\n              <el-tag v-if=\"primaryRole\" size=\"small\" type=\"success\">\n                {{ primaryRole }}\n              </el-tag>\n            </div>\n          </div>\n          <el-divider />\n          <ul class=\"summary-list\">\n            <li>\n              <span>注册时间</span>\n              <span>{{ formattedRegisterTime }}</span>\n            </li>\n            <li>\n              <span>绑定手机号</span>\n              <span>{{ maskedPhone }}</span>\n            </li>\n            <li>\n              <span>最近登录</span>\n              <span>{{ latestDeviceTime }}</span>\n            </li>\n          </ul>\n        </el-card>\n\n        <el-card class=\"devices-card\" shadow=\"hover\">\n          <template #header>\n            <div class=\"card-header\">\n              <span>登录设备</span>\n              <el-button\n                type=\"text\"\n                :icon=\"RefreshRight\"\n                @click=\"loadDevices\"\n                :loading=\"deviceLoading\"\n              >\n                刷新\n              </el-button>\n            </div>\n          </template>\n\n          <el-skeleton v-if=\"deviceLoading\" animated />\n          <el-empty v-else-if=\"!devices.length\" description=\"暂无登录设备信息\" />\n          <el-timeline v-else>\n            <el-timeline-item\n              v-for=\"device in devices\"\n              :key=\"device.id\"\n              :timestamp=\"formatDate(device.lastActiveAt)\"\n              placement=\"top\"\n            >\n              <div class=\"device-item\">\n                <div>\n                  <strong>{{ device.platform || '未知设备' }}</strong>\n                  <p>{{ device.browser || '未知浏览器' }}</p>\n                </div>\n                <small>IP：{{ device.ip || '未知' }}</small>\n              </div>\n            </el-timeline-item>\n          </el-timeline>\n        </el-card>\n      </el-col>\n\n      <el-col :xs=\"24\" :md=\"16\">\n        <el-card class=\"profile-card\" shadow=\"hover\">\n          <template #header>\n            <div class=\"card-header\">\n              <span>个人信息</span>\n              <el-button\n                type=\"primary\"\n                size=\"small\"\n                plain\n                @click=\"toggleEdit\"\n              >\n                {{ editing ? '取消' : '编辑资料' }}\n              </el-button>\n            </div>\n          </template>\n\n          <el-form\n            ref=\"infoFormRef\"\n            :model=\"infoForm\"\n            :rules=\"infoRules\"\n            label-width=\"110px\"\n            class=\"info-form\"\n            :disabled=\"!editing\"\n          >\n            <el-form-item label=\"用户名\">\n              <el-input v-model=\"infoForm.username\" disabled />\n            </el-form-item>\n            <el-form-item label=\"邮箱\">\n              <el-input v-model=\"infoForm.email\" disabled />\n            </el-form-item>\n            <el-form-item prop=\"phone\" label=\"手机号\">\n              <el-input\n                v-model=\"infoForm.phone\"\n                maxlength=\"11\"\n                placeholder=\"请输入新的手机号\"\n              />\n            </el-form-item>\n            <el-form-item prop=\"bio\" label=\"个人简介\">\n              <el-input\n                v-model=\"infoForm.bio\"\n                type=\"textarea\"\n                rows=\"3\"\n                maxlength=\"200\"\n                show-word-limit\n                placeholder=\"简单介绍一下自己\"\n              />\n            </el-form-item>\n            <el-form-item>\n              <el-button\n                type=\"primary\"\n                :loading=\"infoLoading\"\n                @click=\"submitInfo\"\n              >\n                保存\n              </el-button>\n              <el-button @click=\"resetInfo\">重置</el-button>\n            </el-form-item>\n          </el-form>\n        </el-card>\n\n        <el-card class=\"profile-card\" shadow=\"hover\">\n          <template #header>\n            <span>密码修改</span>\n          </template>\n\n          <el-form\n            ref=\"passwordFormRef\"\n            :model=\"passwordForm\"\n            :rules=\"passwordRules\"\n            label-width=\"110px\"\n            class=\"password-form\"\n          >\n            <el-form-item prop=\"oldPassword\" label=\"当前密码\">\n              <el-input\n                v-model=\"passwordForm.oldPassword\"\n                type=\"password\"\n                autocomplete=\"current-password\"\n                placeholder=\"请输入当前密码\"\n              />\n            </el-form-item>\n            <el-form-item prop=\"newPassword\" label=\"新密码\">\n              <el-input\n                v-model=\"passwordForm.newPassword\"\n                type=\"password\"\n                autocomplete=\"new-password\"\n                placeholder=\"请输入新密码\"\n              />\n            </el-form-item>\n            <el-form-item prop=\"confirmPassword\" label=\"确认新密码\">\n              <el-input\n                v-model=\"passwordForm.confirmPassword\"\n                type=\"password\"\n                autocomplete=\"new-password\"\n                placeholder=\"请再次输入新密码\"\n              />\n            </el-form-item>\n            <el-form-item>\n              <el-button\n                type=\"primary\"\n                :loading=\"passwordLoading\"\n                @click=\"submitPassword\"\n              >\n                修改密码\n              </el-button>\n              <el-button @click=\"resetPasswordForm\">重置</el-button>\n            </el-form-item>\n          </el-form>\n        </el-card>\n      </el-col>\n    </el-row>\n  </div>\n</template>\n\n<script setup>\nimport { computed, onMounted, onBeforeUnmount, reactive, ref, watch } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { RefreshRight } from '@element-plus/icons-vue';\n\nimport {\n  sanitizeInput,\n  validatePhoneNumber,\n  validatePasswordStrength\n} from '../../utils/security';\nimport SkeletonCard from '../../components/common/SkeletonCard.vue';\n\nconst store = useStore();\n\nconst profile = computed(() => store.getters['user/userProfile'] || {});\nconst roles = computed(() => store.getters['auth/currentUser']?.roles || []);\n\nconst editing = ref(false);\nconst infoLoading = ref(false);\nconst passwordLoading = ref(false);\nconst deviceLoading = ref(false);\nconst draftStorageKey = 'user.profile.draft';\n\nconst infoFormRef = ref();\nconst passwordFormRef = ref();\n\nconst infoForm = reactive({\n  username: '',\n  email: '',\n  phone: '',\n  bio: ''\n});\n\nconst passwordForm = reactive({\n  oldPassword: '',\n  newPassword: '',\n  confirmPassword: ''\n});\n\nconst devices = ref([]);\nconst userLoading = computed(() => store.getters['user/userLoading']);\nconst globalLoading = computed(() => store.getters.globalLoading);\nconst isBusy = computed(() => userLoading.value || globalLoading.value);\n\nconst infoRules = {\n  phone: [\n    {\n      validator: (_, value, callback) => {\n        if (!value) {\n          callback();\n          return;\n        }\n        const sanitized = sanitizeInput(value);\n        if (sanitized !== value) {\n          infoForm.phone = sanitized;\n        }\n        const result = validatePhoneNumber(sanitized);\n        if (result !== true) {\n          callback(new Error(result));\n        } else {\n          callback();\n        }\n      },\n      trigger: ['blur', 'change']\n    }\n  ],\n  bio: [{ min: 0, max: 200, message: '简介内容需少于 200 字', trigger: 'blur' }]\n};\n\nconst passwordRules = {\n  oldPassword: [{ required: true, message: '请输入当前密码', trigger: 'blur' }],\n  newPassword: [\n    { required: true, message: '请输入新密码', trigger: 'blur' },\n    {\n      validator: (_, value, callback) => {\n        const result = validatePasswordStrength(value);\n        if (!result.valid) {\n          callback(new Error(result.feedback[0] || '密码复杂度不足'));\n        } else {\n          callback();\n        }\n      },\n      trigger: 'change'\n    }\n  ],\n  confirmPassword: [\n    { required: true, message: '请确认新密码', trigger: 'blur' },\n    {\n      validator: (_, value, callback) => {\n        if (value !== passwordForm.newPassword) {\n          callback(new Error('两次输入的密码不一致'));\n        } else {\n          callback();\n        }\n      },\n      trigger: ['blur', 'change']\n    }\n  ]\n};\n\nconst initials = computed(() => {\n  const name = infoForm.username || profile.value.username || '';\n  return name.slice(0, 1).toUpperCase();\n});\n\nconst userAvatar = computed(\n  () => profile.value.avatar || store.getters['auth/currentUser']?.avatar\n);\nconst userDisplayName = computed(() => profile.value.username || '未命名用户');\nconst maskedPhone = computed(() => {\n  const phone = profile.value.phone;\n  if (!phone) return '未绑定';\n  return phone.replace(/^(\\d{3})\\d{4}(\\d{4})$/, '$1****$2');\n});\nconst primaryRole = computed(() => roles.value?.[0] || '');\nconst formattedRegisterTime = computed(() =>\n  formatDate(profile.value.createdAt)\n);\nconst latestDeviceTime = computed(() => {\n  if (!devices.value.length) return '暂无记录';\n  return formatRelative(devices.value[0]?.lastActiveAt);\n});\n\nfunction formatDate(value) {\n  if (!value) return '未知';\n  const date = new Date(value);\n  if (Number.isNaN(date.getTime())) return '未知';\n  return date.toLocaleString();\n}\n\nfunction formatRelative(date) {\n  if (!date) return '未知';\n  const now = Date.now();\n  const diff = now - new Date(date).getTime();\n  if (diff < 0) return '刚刚';\n  const minutes = Math.floor(diff / 60000);\n  if (minutes < 1) return '刚刚';\n  if (minutes < 60) return `${minutes} 分钟前`;\n  const hours = Math.floor(minutes / 60);\n  if (hours < 24) return `${hours} 小时前`;\n  const days = Math.floor(hours / 24);\n  if (days < 7) return `${days} 天前`;\n  return formatDate(date);\n}\n\nfunction fillInfoForm(data) {\n  infoForm.username = data.username || '';\n  infoForm.email = data.email || '';\n  infoForm.phone = data.phone || '';\n  infoForm.bio = data.bio || '';\n}\n\nfunction restoreDraft() {\n  try {\n    const draft = localStorage.getItem(draftStorageKey);\n    if (!draft) return;\n    const parsed = JSON.parse(draft);\n    infoForm.phone = parsed.phone || infoForm.phone;\n    infoForm.bio = parsed.bio || infoForm.bio;\n  } catch (error) {\n    console.warn('读取个人资料草稿失败:', error);\n  }\n}\n\nfunction clearDraft() {\n  localStorage.removeItem(draftStorageKey);\n}\n\nasync function loadProfile(force = false) {\n  try {\n    const data = await store.dispatch('user/fetchProfile', { force });\n    fillInfoForm(data);\n    restoreDraft();\n  } catch (error) {\n    console.error('获取用户信息失败', error);\n  }\n}\n\nasync function loadDevices() {\n  deviceLoading.value = true;\n  try {\n    const data = await store.dispatch('user/fetchDevices');\n    devices.value = data;\n  } catch (error) {\n    console.error('获取设备信息失败', error);\n    devices.value = [];\n  } finally {\n    deviceLoading.value = false;\n  }\n}\n\nfunction toggleEdit() {\n  editing.value = !editing.value;\n  if (!editing.value) {\n    resetInfo();\n    clearDraft();\n  } else {\n    restoreDraft();\n  }\n}\n\nfunction resetInfo() {\n  fillInfoForm(profile.value || {});\n  infoFormRef.value?.clearValidate();\n}\n\nfunction resetPasswordForm() {\n  passwordForm.oldPassword = '';\n  passwordForm.newPassword = '';\n  passwordForm.confirmPassword = '';\n  passwordFormRef.value?.clearValidate();\n}\n\nfunction submitInfo() {\n  if (!infoFormRef.value) return;\n\n  infoFormRef.value.validate(async (valid) => {\n    if (!valid) return;\n    infoLoading.value = true;\n    try {\n      await store.dispatch('user/updateProfile', {\n        phone: sanitizeInput(infoForm.phone),\n        bio: sanitizeInput(infoForm.bio)\n      });\n      await loadProfile(true);\n      ElMessage.success('个人信息已更新');\n      editing.value = false;\n      clearDraft();\n    } catch (error) {\n      ElMessage.error(error?.message || '更新个人信息失败');\n    } finally {\n      infoLoading.value = false;\n    }\n  });\n}\n\nfunction submitPassword() {\n  if (!passwordFormRef.value) return;\n\n  passwordFormRef.value.validate(async (valid) => {\n    if (!valid) return;\n    passwordLoading.value = true;\n    try {\n      await store.dispatch('user/changePassword', {\n        oldPassword: passwordForm.oldPassword,\n        newPassword: passwordForm.newPassword\n      });\n      ElMessage.success('密码修改成功，请使用新密码重新登录');\n      resetPasswordForm();\n    } catch (error) {\n      ElMessage.error(error?.message || '密码修改失败，请稍后再试');\n    } finally {\n      passwordLoading.value = false;\n    }\n  });\n}\n\nonMounted(async () => {\n  if (!profile.value || !Object.keys(profile.value).length) {\n    await loadProfile();\n  } else {\n    fillInfoForm(profile.value);\n    restoreDraft();\n  }\n  await loadDevices();\n});\n\nconst draftFields = computed(() => ({\n  phone: infoForm.phone,\n  bio: infoForm.bio\n}));\n\nlet draftTimer = null;\n\nwatch(\n  [draftFields, editing],\n  ([fields, isEditing]) => {\n    if (!isEditing) return;\n    if (draftTimer) clearTimeout(draftTimer);\n    draftTimer = setTimeout(() => {\n      try {\n        localStorage.setItem(draftStorageKey, JSON.stringify(fields));\n      } catch (error) {\n        console.warn('保存个人资料草稿失败:', error);\n      }\n    }, 500);\n  },\n  { deep: true }\n);\n\nonBeforeUnmount(() => {\n  if (draftTimer) clearTimeout(draftTimer);\n});\n</script>\n\n<style scoped>\n.profile-wrapper {\n  padding: 20px 0 40px;\n}\n\n.profile-skeleton-stack {\n  display: grid;\n  gap: 20px;\n}\n\n.profile-card {\n  margin-bottom: 20px;\n  border-radius: 16px;\n}\n\n.profile-summary {\n  display: flex;\n  align-items: center;\n  gap: 16px;\n}\n\n.summary-info h2 {\n  margin: 0;\n  font-size: 20px;\n  color: #1f2937;\n}\n\n.summary-info p {\n  margin: 6px 0 0;\n  color: #6b7280;\n  font-size: 14px;\n}\n\n.summary-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  color: #4b5563;\n  font-size: 14px;\n}\n\n.summary-list li {\n  display: flex;\n  justify-content: space-between;\n}\n\n.card-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  font-weight: 600;\n}\n\n.info-form,\n.password-form {\n  max-width: 520px;\n}\n\n.device-item {\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  gap: 12px;\n}\n\n.devices-card {\n  border-radius: 16px;\n}\n\n@media (max-width: 768px) {\n  .profile-wrapper {\n    padding: 12px 0 24px;\n  }\n\n  .info-form,\n  .password-form {\n    max-width: 100%;\n  }\n}\n</style>\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}