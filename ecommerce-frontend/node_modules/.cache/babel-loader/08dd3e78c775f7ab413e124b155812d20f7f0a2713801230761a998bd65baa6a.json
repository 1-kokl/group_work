{"ast":null,"code":"import userAPI, { invalidateUserCaches } from '../../services/api/userAPI';\nconst PROFILE_STORAGE_KEY = 'user.profile';\nconst SETTINGS_STORAGE_KEY = 'user.settings';\nfunction readJson(key) {\n  try {\n    const raw = localStorage.getItem(key);\n    return raw ? JSON.parse(raw) : null;\n  } catch (error) {\n    console.warn(`[user] 读取 ${key} 失败:`, error);\n    return null;\n  }\n}\nfunction writeJson(key, value) {\n  try {\n    if (value === null || value === undefined) {\n      localStorage.removeItem(key);\n    } else {\n      localStorage.setItem(key, JSON.stringify(value));\n    }\n  } catch (error) {\n    console.warn(`[user] 写入 ${key} 失败:`, error);\n  }\n}\nconst state = () => ({\n  profile: readJson(PROFILE_STORAGE_KEY),\n  settings: readJson(SETTINGS_STORAGE_KEY) || {},\n  lastFetchedAt: null,\n  loading: false,\n  error: null\n});\nconst getters = {\n  userProfile: state => state.profile,\n  userSettings: state => state.settings,\n  profileLoaded: state => Boolean(state.profile),\n  profileLastFetchedAt: state => state.lastFetchedAt,\n  userLoading: state => state.loading,\n  userError: state => state.error\n};\nconst mutations = {\n  SET_PROFILE(state, profile) {\n    state.profile = profile || null;\n    writeJson(PROFILE_STORAGE_KEY, state.profile);\n  },\n  SET_SETTINGS(state, settings) {\n    state.settings = settings || {};\n    writeJson(SETTINGS_STORAGE_KEY, state.settings);\n  },\n  SET_LAST_FETCHED_AT(state, timestamp) {\n    state.lastFetchedAt = timestamp || null;\n  },\n  SET_LOADING(state, value) {\n    state.loading = value;\n  },\n  SET_ERROR(state, error) {\n    state.error = error || null;\n  },\n  RESET_PROFILE(state) {\n    state.profile = null;\n    state.settings = {};\n    state.lastFetchedAt = null;\n    state.loading = false;\n    state.error = null;\n    localStorage.removeItem(PROFILE_STORAGE_KEY);\n    localStorage.removeItem(SETTINGS_STORAGE_KEY);\n  }\n};\nconst actions = {\n  setProfile({\n    commit\n  }, profile) {\n    commit('SET_PROFILE', profile);\n    commit('SET_LAST_FETCHED_AT', Date.now());\n  },\n  setSettings({\n    commit\n  }, settings) {\n    commit('SET_SETTINGS', settings);\n  },\n  async fetchProfile({\n    commit,\n    state\n  }, {\n    force = false\n  } = {}) {\n    if (!force && state.profile) {\n      return state.profile;\n    }\n    commit('SET_LOADING', true);\n    commit('SET_ERROR', null);\n    try {\n      const profile = await userAPI.getProfile({\n        force\n      });\n      commit('SET_PROFILE', profile);\n      commit('SET_LAST_FETCHED_AT', Date.now());\n      return profile;\n    } catch (error) {\n      commit('SET_ERROR', error);\n      throw error;\n    } finally {\n      commit('SET_LOADING', false);\n    }\n  },\n  async updateProfile({\n    commit,\n    dispatch,\n    state\n  }, payload) {\n    commit('SET_LOADING', true);\n    commit('SET_ERROR', null);\n    try {\n      await userAPI.updateProfile(payload);\n      const nextProfile = {\n        ...(state.profile || {}),\n        ...payload\n      };\n      commit('SET_PROFILE', nextProfile);\n      commit('SET_LAST_FETCHED_AT', Date.now());\n      dispatch('auth/updateUser', nextProfile, {\n        root: true\n      });\n      return nextProfile;\n    } catch (error) {\n      commit('SET_ERROR', error);\n      throw error;\n    } finally {\n      commit('SET_LOADING', false);\n    }\n  },\n  async changePassword({\n    commit\n  }, payload) {\n    commit('SET_LOADING', true);\n    commit('SET_ERROR', null);\n    try {\n      await userAPI.changePassword(payload);\n    } catch (error) {\n      commit('SET_ERROR', error);\n      throw error;\n    } finally {\n      commit('SET_LOADING', false);\n    }\n  },\n  async fetchDevices() {\n    return userAPI.getDevices();\n  },\n  clearProfile({\n    commit\n  }) {\n    commit('RESET_PROFILE');\n    invalidateUserCaches();\n  }\n};\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  mutations,\n  actions\n};","map":{"version":3,"names":["userAPI","invalidateUserCaches","PROFILE_STORAGE_KEY","SETTINGS_STORAGE_KEY","readJson","key","raw","localStorage","getItem","JSON","parse","error","console","warn","writeJson","value","undefined","removeItem","setItem","stringify","state","profile","settings","lastFetchedAt","loading","getters","userProfile","userSettings","profileLoaded","Boolean","profileLastFetchedAt","userLoading","userError","mutations","SET_PROFILE","SET_SETTINGS","SET_LAST_FETCHED_AT","timestamp","SET_LOADING","SET_ERROR","RESET_PROFILE","actions","setProfile","commit","Date","now","setSettings","fetchProfile","force","getProfile","updateProfile","dispatch","payload","nextProfile","root","changePassword","fetchDevices","getDevices","clearProfile","namespaced"],"sources":["C:/Users/Administrator/Desktop/zonshe/ecommerce-frontend/src/store/modules/user.js"],"sourcesContent":["import userAPI, { invalidateUserCaches } from '../../services/api/userAPI';\n\nconst PROFILE_STORAGE_KEY = 'user.profile';\nconst SETTINGS_STORAGE_KEY = 'user.settings';\n\nfunction readJson(key) {\n  try {\n    const raw = localStorage.getItem(key);\n    return raw ? JSON.parse(raw) : null;\n  } catch (error) {\n    console.warn(`[user] 读取 ${key} 失败:`, error);\n    return null;\n  }\n}\n\nfunction writeJson(key, value) {\n  try {\n    if (value === null || value === undefined) {\n      localStorage.removeItem(key);\n    } else {\n      localStorage.setItem(key, JSON.stringify(value));\n    }\n  } catch (error) {\n    console.warn(`[user] 写入 ${key} 失败:`, error);\n  }\n}\n\nconst state = () => ({\n  profile: readJson(PROFILE_STORAGE_KEY),\n  settings: readJson(SETTINGS_STORAGE_KEY) || {},\n  lastFetchedAt: null,\n  loading: false,\n  error: null\n});\n\nconst getters = {\n  userProfile: (state) => state.profile,\n  userSettings: (state) => state.settings,\n  profileLoaded: (state) => Boolean(state.profile),\n  profileLastFetchedAt: (state) => state.lastFetchedAt,\n  userLoading: (state) => state.loading,\n  userError: (state) => state.error\n};\n\nconst mutations = {\n  SET_PROFILE(state, profile) {\n    state.profile = profile || null;\n    writeJson(PROFILE_STORAGE_KEY, state.profile);\n  },\n  SET_SETTINGS(state, settings) {\n    state.settings = settings || {};\n    writeJson(SETTINGS_STORAGE_KEY, state.settings);\n  },\n  SET_LAST_FETCHED_AT(state, timestamp) {\n    state.lastFetchedAt = timestamp || null;\n  },\n  SET_LOADING(state, value) {\n    state.loading = value;\n  },\n  SET_ERROR(state, error) {\n    state.error = error || null;\n  },\n  RESET_PROFILE(state) {\n    state.profile = null;\n    state.settings = {};\n    state.lastFetchedAt = null;\n    state.loading = false;\n    state.error = null;\n    localStorage.removeItem(PROFILE_STORAGE_KEY);\n    localStorage.removeItem(SETTINGS_STORAGE_KEY);\n  }\n};\n\nconst actions = {\n  setProfile({ commit }, profile) {\n    commit('SET_PROFILE', profile);\n    commit('SET_LAST_FETCHED_AT', Date.now());\n  },\n\n  setSettings({ commit }, settings) {\n    commit('SET_SETTINGS', settings);\n  },\n\n  async fetchProfile({ commit, state }, { force = false } = {}) {\n    if (!force && state.profile) {\n      return state.profile;\n    }\n\n    commit('SET_LOADING', true);\n    commit('SET_ERROR', null);\n\n    try {\n      const profile = await userAPI.getProfile({ force });\n      commit('SET_PROFILE', profile);\n      commit('SET_LAST_FETCHED_AT', Date.now());\n      return profile;\n    } catch (error) {\n      commit('SET_ERROR', error);\n      throw error;\n    } finally {\n      commit('SET_LOADING', false);\n    }\n  },\n\n  async updateProfile({ commit, dispatch, state }, payload) {\n    commit('SET_LOADING', true);\n    commit('SET_ERROR', null);\n\n    try {\n      await userAPI.updateProfile(payload);\n      const nextProfile = {\n        ...(state.profile || {}),\n        ...payload\n      };\n      commit('SET_PROFILE', nextProfile);\n      commit('SET_LAST_FETCHED_AT', Date.now());\n      dispatch('auth/updateUser', nextProfile, { root: true });\n      return nextProfile;\n    } catch (error) {\n      commit('SET_ERROR', error);\n      throw error;\n    } finally {\n      commit('SET_LOADING', false);\n    }\n  },\n\n  async changePassword({ commit }, payload) {\n    commit('SET_LOADING', true);\n    commit('SET_ERROR', null);\n    try {\n      await userAPI.changePassword(payload);\n    } catch (error) {\n      commit('SET_ERROR', error);\n      throw error;\n    } finally {\n      commit('SET_LOADING', false);\n    }\n  },\n\n  async fetchDevices() {\n    return userAPI.getDevices();\n  },\n\n  clearProfile({ commit }) {\n    commit('RESET_PROFILE');\n    invalidateUserCaches();\n  }\n};\n\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  mutations,\n  actions\n};\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}